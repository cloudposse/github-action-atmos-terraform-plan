# tfcmt Configuration used for posting Terraform GitHub Summaries
# https://suzuki-shunsuke.github.io/tfcmt/config
embedded_var_names: []
ci:
  pr: []
  owner: []
  repo: []
  sha: []
  link: []
  vars: {}
templates:
  plan_title: |
    {{ if eq .ExitCode 1 }}
    ## :x: Plan Failed for `{{.Vars.component}}` in `{{.Vars.stack}}`!
    {{ end }}
    {{- if eq .ExitCode 0 }}
    ## Plan Succeeded for `{{.Vars.component}}` in `{{.Vars.stack}}`
    
    {{ if .CreatedResources}}[![create](https://shields.io/badge/PLAN-CREATE-success?style=for-the-badge)](#user-content-create){{ end }}
    {{- if .UpdatedResources }} [![change](https://shields.io/badge/PLAN-CHANGE-important?style=for-the-badge)](#user-content-change){{ end }}
    {{- if .ReplacedResources }} [![replace](https://shields.io/badge/PLAN-REPLACE-critical?style=for-the-badge)](#user-content-replace){{ end }}
    {{- if .DeletedResources }} [![destroy](https://shields.io/badge/PLAN-DESTROY-critical?style=for-the-badge)](#user-content-destroy){{ end }}
    {{- if not (or .CreatedResources .UpdatedResources .ReplacedResources .DeletedResources) }} [![no changes](https://shields.io/badge/-NO_CHANGE-inactive?style=for-the-badge)](#user-content-result){{ end }}{{ end }}

  result: |
    <details><summary><a id="result" />{{if .Result}}{{ .Result }}{{end}}</summary>

    <br/>
    To reproduce this locally, run:<br/><br/>

  updated_resources: |
    ---
    {{- if .CreatedResources}}
    ### <a id="create" />Create
    ```diff
    {{- range .CreatedResources}}
    + {{.}}
    {{- end}}
    ```
    {{- end}}
    {{- if .UpdatedResources}}
    ### <a id="change" />Change
    ```diff
    {{- range .UpdatedResources}}
    ~ {{.}}
    {{- end}}
    ```
    {{- end}}
    {{- if .ReplacedResources}}
    ### <a id="replace" />Replace
    ```diff
    {{- range .ReplacedResources}}
    - {{.}}
    + {{.}}
    {{- end}}
    ```
    {{- end}}
    {{- if .DeletedResources}}
    ### <a id="destroy" />Destroy
    ```diff
    {{- range .DeletedResources}}
    - {{.}}
    {{- end}}
    ```
    {{ end}}
    </details>
  deletion_warning: |
    {{if .HasDestroy}}
    ### :warning: Resource Deletion will happen :warning:
    This plan contains resource delete operation. Please check the plan result very carefully!
    {{end}}
  change_outside_terraform: |
    {{if .ChangeOutsideTerraform}}
    <details><summary>:information_source: Objects have changed outside of Terraform</summary>

    _This feature was introduced from [Terraform v0.15.4](https://github.com/hashicorp/terraform/releases/tag/v0.15.4)._
    {{wrapCode .ChangeOutsideTerraform}}
    </details>
    {{end}}
  warning: |
    {{if .Warning}}
    ## :warning: Warnings :warning:
    {{wrapCode .Warning}}
    {{end}}
  error_messages: |
    {{if .ErrorMessages}}
    ## :warning: Errors
    {{range .ErrorMessages}}
    * {{. -}}
    {{- end}}{{end}}
  infracost: |
    <details><summary>
    {{- $cost := .Vars.infracost_total_monthly_cost | float64 }}
    {{- $roundedCost := printf "%.2f" $cost }}
    {{- if eq $cost 0.0 }}
    Infracost Estimate: monthly cost will not change
    {{- else if gt $cost 0.0 }}
    Infracost Estimate: monthly cost will increase by ${{ $roundedCost }} ðŸ“ˆ
    {{- else }}
    Infracost Estimate: monthly cost will decrease by ${{ $roundedCost }} ðŸ“‰
    {{- end }}
    </summary>

      ```
      {{- b64dec .Vars.infracost_details_diff_breakdown | html }}
      ```

    </details>
terraform:
  plan:
    disable_label: false
    template: |
      {{template "plan_title" .}}

      {{template "deletion_warning" .}}
      {{template "result" .}}
      ```shell
      atmos terraform plan {{.Vars.component}} -s {{.Vars.stack}}
      ```
      {{template "updated_resources" .}}
      {{if .ChangedResult}}
      <details><summary>Terraform <strong>Plan</strong> Summary</summary>
      {{wrapCode .ChangedResult}}
      </details>
      {{end}}
      {{template "change_outside_terraform" .}}
      {{template "warning" .}}
      {{template "error_messages" .}}
      {{if ne .Vars.infracost_details_diff_breakdown ""}}
      {{template "infracost" .}}
      {{end}}
    when_parse_error:
      template: |
        {{template "plan_title" .}}

        Failed to parse the result.

        <details><summary>Result</summary>
        {{wrapCode .CombinedOutput}}
        </details>
